name: Lint

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  eslint:
    name: ESLint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Annotate code with ESLint results
        uses: ataylorme/eslint-annotate-action@v3
        if: always()
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          report-json: "eslint_report.json"
          check-name: "ESLint Results"
        continue-on-error: true

  prettier:
    name: Prettier
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        run: npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}"

  commitlint:
    name: Commit Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate commit messages
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
        continue-on-error: true

  prisma-validate:
    name: Prisma Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate Prisma schema
        run: npx prisma validate

      - name: Check for missing migrations
        run: npx prisma migrate status
        continue-on-error: true

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint markdown files
        uses: avto-dev/markdown-lint@v1
        with:
          config: ".markdownlint.json"
          args: "**/*.md"
        continue-on-error: true

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [eslint, prettier, prisma-validate]
    if: always()

    steps:
      - name: Check lint results
        run: |
          if [ "${{ needs.eslint.result }}" == "success" ] && \
             [ "${{ needs.prettier.result }}" == "success" ] && \
             [ "${{ needs.prisma-validate.result }}" == "success" ]; then
            echo "✅ All lint checks passed!"
            exit 0
          else
            echo "❌ Some lint checks failed"
            echo "ESLint: ${{ needs.eslint.result }}"
            echo "Prettier: ${{ needs.prettier.result }}"
            echo "Prisma: ${{ needs.prisma-validate.result }}"
            exit 1
          fi
